# Архитектура приложения

## Общая архитектура

Приложение построено по принципу клиент-серверной архитектуры:

```
┌─────────────┐         HTTP/REST API         ┌─────────────┐
│   Frontend  │ ◄──────────────────────────► │   Backend   │
│   (React)   │                               │   (Django)  │
└─────────────┘                               └─────────────┘
                                                      │
                                                      ▼
                                              ┌─────────────┐
                                              │  PostgreSQL │
                                              └─────────────┘
```

## Backend архитектура

### Структура приложений

```
backend/
├── apps/
│   ├── users/          # Аутентификация и управление пользователями
│   │   ├── models.py   # Модель User (расширение стандартной)
│   │   ├── views.py    # API views для регистрации/входа
│   │   ├── serializers.py
│   │   └── urls.py
│   │
│   ├── words/          # Управление словами
│   │   ├── models.py   # Модель Word
│   │   ├── views.py    # API для работы со словами
│   │   ├── serializers.py
│   │   └── urls.py
│   │
│   └── cards/          # Генерация карточек Anki
│       ├── views.py    # API для генерации .apkg
│       ├── utils.py    # Утилиты для работы с genanki
│       └── urls.py
│
└── config/
    ├── settings.py     # Настройки Django
    └── urls.py         # Главный URL router
```

### Поток данных

1. **Регистрация/Вход:**
   - Frontend → POST `/api/auth/register/` или `/api/auth/login/`
   - Backend → Создание/проверка пользователя
   - Backend → Возврат токена
   - Frontend → Сохранение токена в localStorage

2. **Генерация медиафайлов (опционально):**
   - Frontend → POST `/api/media/generate-image/` или `/api/media/generate-audio/` (с токеном)
   - Backend → Вызов OpenAI API (DALL-E 3 для изображений, TTS-1-HD для аудио)
   - Backend → Сохранение медиафайла локально
   - Backend → Возврат URL к медиафайлу
   - Frontend → Предпросмотр медиафайла

3. **Генерация карточек:**
   - Frontend → POST `/api/cards/generate/` (с токеном, словами, переводами, медиафайлами)
   - Backend → Валидация данных
   - Backend → Сохранение слов в БД
   - Backend → Генерация .apkg через genanki (включая медиафайлы)
   - Backend → Возврат ссылки на скачивание
   - Frontend → GET `/api/cards/download/<file_id>/`
   - Frontend → Скачивание файла

## Frontend архитектура

### Структура компонентов

```
frontend/src/
├── components/         # React компоненты
│   ├── WordInput.tsx
│   ├── LanguageSelector.tsx
│   ├── GenerateButton.tsx
│   └── ...
│
├── services/           # API клиент
│   └── api.ts
│
├── types/             # TypeScript типы
│   └── index.ts
│
├── contexts/           # React Contexts
│   └── AuthContext.tsx
│
└── App.tsx            # Главный компонент
```

### Поток данных в Frontend

1. **Аутентификация:**
   - Пользователь вводит данные
   - Компонент вызывает `apiService.login()` или `apiService.register()`
   - Токен сохраняется в localStorage
   - Состояние аутентификации обновляется через Context

2. **Генерация карточек:**
   - Пользователь вводит слова и переводы
   - Компонент собирает данные
   - Вызов `apiService.generateCards()`
   - Получение ссылки на скачивание
   - Автоматическое скачивание файла

## База данных

### Схема

```
User
├── id (PK)
├── username
├── email
├── password (hashed)
├── preferred_language
└── created_at

Word
├── id (PK)
├── user (FK → User)
├── original_word
├── translation
├── language
├── audio_file (nullable)
├── image_file (nullable)
├── created_at
└── updated_at

Index: (user, original_word, language) - unique
```

## Безопасность

- Аутентификация через токены (DRF Token Authentication)
- CORS настроен только для разрешенных доменов
- Валидация всех входных данных
- Изоляция данных пользователей (каждый видит только свои слова)

## Формат файлов Anki (.apkg)

### Структура .apkg файла

- **Один .apkg файл = одна колода карточек** (может содержать множество карточек)
- Файл .apkg представляет собой ZIP-архив, содержащий:
  - Базу данных SQLite с записями (notes) и карточками (cards)
  - Папку `media/` с медиафайлами (изображения, аудио)
  - Метаданные колоды (название, описание, настройки)
- **Колода обязательно должна иметь название** при создании
- Для создания .apkg файлов используется библиотека `genanki` (Python)

### Логика генерации .apkg

1. **Создание модели карточки (Note Type):**
   - Поля: OriginalWord, Translation, Audio, Image
   - Два шаблона для двусторонних карточек:
     - Карточка 1: Иностранное слово → Русский перевод
     - Карточка 2: Русский перевод → Иностранное слово

2. **Создание колоды:**
   - Уникальный ID колоды
   - Название колоды (обязательно)

3. **Добавление записей (Notes):**
   - Для каждого слова создается одна запись (Note)
   - Из одной записи генерируются две карточки

4. **Упаковка медиафайлов:**
   - Все медиафайлы (аудио и изображения) добавляются в пакет
   - genanki автоматически упаковывает их в .apkg архив

5. **Генерация файла:**
   - Сохранение .apkg файла во временное хранилище
   - Возврат ссылки на скачивание

### Модели OpenAI

- **Изображения:** DALL-E 3 (`dall-e-3`)
  - Размер: 1024x1024
  - Качество: standard
  - Промпт формируется автоматически на основе слова и перевода

- **Аудио:** TTS-1-HD (`tts-1-hd`)
  - Формат: MP3
  - Голос выбирается в зависимости от языка (pt → португальский, de → немецкий)

## Масштабируемость

- Модульная структура приложений
- RESTful API для легкого расширения
- Готовность к добавлению новых языков
- Интеграция с OpenAI API для автоматической генерации медиа

