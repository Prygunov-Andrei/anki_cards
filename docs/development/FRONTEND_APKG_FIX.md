# –ü—Ä–æ–±–ª–µ–º–∞: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è .apkg –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–π –∫–æ–ª–æ–¥—ã

## üîç –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º—ã

### –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:

1. **–§—Ä–æ–Ω—Ç–µ–Ω–¥ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `POST /api/cards/generate/`** —Å:
   - `image_files: { '—Å–ª–æ–≤–æ': '/media/images/xxx.jpg' }` (–æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ –ø—É—Ç–∏)
   - `audio_files: { '—Å–ª–æ–≤–æ': '/media/audio/xxx.mp3' }` (–æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ –ø—É—Ç–∏)

2. **–ë—ç–∫–µ–Ω–¥ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤:**
   ```python
   if os.path.exists(audio_path):  # audio_path = '/media/images/xxx.jpg'
   ```
   - ‚ùå **–ü—Ä–æ–±–ª–µ–º–∞:** `os.path.exists('/media/images/xxx.jpg')` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `False`, –ø–æ—Ç–æ–º—É —á—Ç–æ —ç—Ç–æ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å, –∞ –Ω–µ –∞–±—Å–æ–ª—é—Ç–Ω—ã–π –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É –Ω–∞ –¥–∏—Å–∫–µ

3. **–ë—ç–∫–µ–Ω–¥ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç .apkg –ë–ï–ó –º–µ–¥–∏–∞—Ñ–∞–π–ª–æ–≤**, –ø–æ—Ç–æ–º—É —á—Ç–æ –≤—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ `os.path.exists()` –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç `False`

4. **–§—Ä–æ–Ω—Ç–µ–Ω–¥ –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ—Ç –º–µ–¥–∏–∞—Ñ–∞–π–ª—ã –∫ —Å–ª–æ–≤–∞–º —á–µ—Ä–µ–∑ `PATCH`**, –Ω–æ —ç—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç **–ü–û–°–õ–ï** –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ `.apkg`

### –†–µ–∑—É–ª—å—Ç–∞—Ç:
- `.apkg` —Ñ–∞–π–ª —Å–æ–∑–¥–∞–µ—Ç—Å—è —Ä–∞–∑–º–µ—Ä–æ–º 50-60 KB (–±–µ–∑ –º–µ–¥–∏–∞)
- –ú–µ–¥–∏–∞—Ñ–∞–π–ª—ã –ø—Ä–∏–≤—è–∑—ã–≤–∞—é—Ç—Å—è –∫ —Å–ª–æ–≤–∞–º –≤ –ë–î, –Ω–æ –Ω–µ –ø–æ–ø–∞–¥–∞—é—Ç –≤ —É–∂–µ —Å–æ–∑–¥–∞–Ω–Ω—ã–π `.apkg`

---

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ò—Å–ø—Ä–∞–≤–∏—Ç—å –±—ç–∫–µ–Ω–¥ (–†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø)

**–ü—Ä–æ–±–ª–µ–º–∞:** –ë—ç–∫–µ–Ω–¥ –Ω–µ –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ –ø—É—Ç–∏ –≤ –∞–±—Å–æ–ª—é—Ç–Ω—ã–µ.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** –í `generate_cards_view` –Ω—É–∂–Ω–æ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤—ã–≤–∞—Ç—å –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ –ø—É—Ç–∏ `/media/...` –≤ –∞–±—Å–æ–ª—é—Ç–Ω—ã–µ –ø—É—Ç–∏ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º `MEDIA_ROOT`.

```python
# –í generate_cards_view, —Å—Ç—Ä–æ–∫–∏ 174-182 –∏ 197-205

if audio_path:
    # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å –≤ –∞–±—Å–æ–ª—é—Ç–Ω—ã–π
    if audio_path.startswith('/media/'):
        # –£–±–∏—Ä–∞–µ–º /media/ –∏ –¥–æ–±–∞–≤–ª—è–µ–º MEDIA_ROOT
        relative_path = audio_path.replace('/media/', '')
        audio_path = Path(settings.MEDIA_ROOT) / relative_path
    elif not Path(audio_path).is_absolute():
        # –ï—Å–ª–∏ –ø—É—Ç—å –Ω–µ –∞–±—Å–æ–ª—é—Ç–Ω—ã–π –∏ –Ω–µ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å /media/, –¥–æ–±–∞–≤–ª—è–µ–º MEDIA_ROOT
        audio_path = Path(settings.MEDIA_ROOT) / audio_path
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞
    if audio_path.exists():
        word_data['audio_file'] = str(audio_path)
        # ...
```

**–¢–æ –∂–µ —Å–∞–º–æ–µ –¥–ª—è `image_path`.**

---

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ò—Å–ø—Ä–∞–≤–∏—Ç—å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ (–ë–´–°–¢–†–û–ï –†–ï–®–ï–ù–ò–ï)

**–ü—Ä–æ–±–ª–µ–º–∞:** –§—Ä–æ–Ω—Ç–µ–Ω–¥ –ø–µ—Ä–µ–¥–∞–µ—Ç –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ –ø—É—Ç–∏ –≤–º–µ—Å—Ç–æ –ø–æ–ª–Ω—ã—Ö URL –∏–ª–∏ –∞–±—Å–æ–ª—é—Ç–Ω—ã—Ö –ø—É—Ç–µ–π.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** –§—Ä–æ–Ω—Ç–µ–Ω–¥ –¥–æ–ª–∂–µ–Ω –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å **–ø–æ–ª–Ω—ã–µ URL** –º–µ–¥–∏–∞—Ñ–∞–π–ª–æ–≤:

```typescript
// ‚ùå –ü–õ–û–•–û: –û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ –ø—É—Ç–∏
const imageFiles = {
  'vorstellen': '/media/images/7a210643-77eb-4759-b273-b45601199437.jpg'
};

// ‚úÖ –•–û–†–û–®–û: –ü–æ–ª–Ω—ã–µ URL
const imageFiles = {
  'vorstellen': 'https://get-anki.fan.ngrok.app/media/images/7a210643-77eb-4759-b273-b45601199437.jpg'
};
```

**–ò–ª–∏:** –§—Ä–æ–Ω—Ç–µ–Ω–¥ –¥–æ–ª–∂–µ–Ω –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤—ã–≤–∞—Ç—å –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ –ø—É—Ç–∏ –≤ –∞–±—Å–æ–ª—é—Ç–Ω—ã–µ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π:

```typescript
const baseURL = 'https://get-anki.fan.ngrok.app';

const imageFiles = Object.entries(generatedImages).reduce((acc, [word, url]) => {
  // –ï—Å–ª–∏ URL –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π, –¥–µ–ª–∞–µ–º –µ–≥–æ –ø–æ–ª–Ω—ã–º
  const fullUrl = url.startsWith('http') ? url : `${baseURL}${url}`;
  acc[word] = fullUrl;
  return acc;
}, {});
```

**–ù–û:** –ë—ç–∫–µ–Ω–¥ –≤—Å–µ —Ä–∞–≤–Ω–æ –¥–æ–ª–∂–µ–Ω —É–º–µ—Ç—å –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –ø–æ–ª–Ω—ã–µ URL –∏ –∏–∑–≤–ª–µ–∫–∞—Ç—å –∏–∑ –Ω–∏—Ö –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ –ø—É—Ç–∏ –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ñ–∞–π–ª–æ–≤ –Ω–∞ –¥–∏—Å–∫–µ.

---

## üéØ –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–µ —Ä–µ—à–µ–Ω–∏–µ (–∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ)

### 1. –§—Ä–æ–Ω—Ç–µ–Ω–¥: –ü–µ—Ä–µ–¥–∞–≤–∞—Ç—å –ø–æ–ª–Ω—ã–µ URL

```typescript
// –ü—Ä–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è POST /api/cards/generate/
const baseURL = 'https://get-anki.fan.ngrok.app'; // –∏–ª–∏ –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞

const imageFiles = {};
const audioFiles = {};

for (const word of words) {
  // –ü–æ–ª—É—á–∞–µ–º URL –∏–∑ –æ—Ç–≤–µ—Ç–æ–≤ API –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
  const imageUrl = imageResponse.data.image_url; // –ú–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–º –∏–ª–∏ –ø–æ–ª–Ω—ã–º
  const audioUrl = audioResponse.data.audio_url; // –ú–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–º –∏–ª–∏ –ø–æ–ª–Ω—ã–º
  
  // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ –ø–æ–ª–Ω—ã–µ URL, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
  imageFiles[word] = imageUrl.startsWith('http') 
    ? imageUrl 
    : `${baseURL}${imageUrl.startsWith('/') ? imageUrl : '/' + imageUrl}`;
  
  audioFiles[word] = audioUrl.startsWith('http') 
    ? audioUrl 
    : `${baseURL}${audioUrl.startsWith('/') ? audioUrl : '/' + audioUrl}`;
}

// –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –±—ç–∫–µ–Ω–¥
await api.post('/cards/generate/', {
  words: words.join(','),
  language: 'de',
  translations: translations,
  deck_name: '–ù–æ–≤–∞—è –∫–æ–ª–æ–¥–∞',
  image_files: imageFiles,  // –ü–æ–ª–Ω—ã–µ URL
  audio_files: audioFiles,  // –ü–æ–ª–Ω—ã–µ URL
  save_to_decks: true
});
```

### 2. –ë—ç–∫–µ–Ω–¥: –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –∏ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ –ø—É—Ç–∏, –∏ –ø–æ–ª–Ω—ã–µ URL

```python
# –í generate_cards_view

def normalize_media_path(path: str) -> Path:
    """
    –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –ø—É—Ç—å –∫ –º–µ–¥–∏–∞—Ñ–∞–π–ª—É (–æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –∏–ª–∏ –ø–æ–ª–Ω—ã–π URL) –≤ –∞–±—Å–æ–ª—é—Ç–Ω—ã–π –ø—É—Ç—å –Ω–∞ –¥–∏—Å–∫–µ
    """
    from django.conf import settings
    media_root = Path(settings.MEDIA_ROOT)
    
    # –ï—Å–ª–∏ —ç—Ç–æ –ø–æ–ª–Ω—ã–π URL, –∏–∑–≤–ª–µ–∫–∞–µ–º –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å
    if path.startswith('http://') or path.startswith('https://'):
        # –ò–∑–≤–ª–µ–∫–∞–µ–º –ø—É—Ç—å –ø–æ—Å–ª–µ /media/
        if '/media/' in path:
            relative_path = path.split('/media/')[-1]
            return media_root / relative_path
        else:
            # –ï—Å–ª–∏ –Ω–µ –º–æ–∂–µ–º –∏–∑–≤–ª–µ—á—å, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–∫ –µ—Å—Ç—å (–¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–∫–∏)
            return Path(path)
    
    # –ï—Å–ª–∏ —ç—Ç–æ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å, –Ω–∞—á–∏–Ω–∞—é—â–∏–π—Å—è —Å /media/
    if path.startswith('/media/'):
        relative_path = path.replace('/media/', '')
        return media_root / relative_path
    
    # –ï—Å–ª–∏ —ç—Ç–æ —É–∂–µ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å –±–µ–∑ /media/
    if not Path(path).is_absolute():
        return media_root / path
    
    # –ï—Å–ª–∏ —ç—Ç–æ —É–∂–µ –∞–±—Å–æ–ª—é—Ç–Ω—ã–π –ø—É—Ç—å
    return Path(path)

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
if audio_path:
    normalized_path = normalize_media_path(audio_path)
    if normalized_path.exists():
        word_data['audio_file'] = str(normalized_path)
        # ...
```

---

## üìã –ß–µ–∫-–ª–∏—Å—Ç –¥–ª—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞

- [ ] –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ `image_files` –∏ `audio_files` —Å–æ–¥–µ—Ä–∂–∞—Ç **–ø–æ–ª–Ω—ã–µ URL** (–Ω–∞—á–∏–Ω–∞—é—Ç—Å—è —Å `https://`)
- [ ] –ï—Å–ª–∏ URL –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ (`/media/...`), –ø—Ä–µ–æ–±—Ä–∞–∑—É–π—Ç–µ –∏—Ö –≤ –ø–æ–ª–Ω—ã–µ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
- [ ] –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∫–ª—é—á–∏ –≤ `image_files` –∏ `audio_files` **—Ç–æ—á–Ω–æ —Å–æ–≤–ø–∞–¥–∞—é—Ç** —Å–æ —Å–ª–æ–≤–∞–º–∏ –≤ `words`
- [ ] –ü–æ—Å–ª–µ `POST /api/cards/generate/` **–ù–ï –Ω—É–∂–Ω–æ** –¥–µ–ª–∞—Ç—å `PATCH` –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏ –º–µ–¥–∏–∞ ‚Äî –±—ç–∫–µ–Ω–¥ –¥–æ–ª–∂–µ–Ω –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–µ–¥–∏–∞ –∏–∑ –∑–∞–ø—Ä–æ—Å–∞
- [ ] –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑–º–µ—Ä —Å–∫–∞—á–∞–Ω–Ω–æ–≥–æ `.apkg` —Ñ–∞–π–ª–∞ ‚Äî –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å > 1 MB –¥–ª—è –∫–æ–ª–æ–¥—ã —Å –º–µ–¥–∏–∞

---

## üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞:

```typescript
// –ü–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π POST /api/cards/generate/
console.log('image_files:', image_files);
console.log('audio_files:', audio_files);

// –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –ø—É—Ç–∏ –ø–æ–ª–Ω—ã–µ:
Object.values(image_files).forEach(url => {
  if (!url.startsWith('http')) {
    console.error('‚ùå –û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å:', url);
  } else {
    console.log('‚úÖ –ü–æ–ª–Ω—ã–π URL:', url);
  }
});
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –ª–æ–≥–∞—Ö –±—ç–∫–µ–Ω–¥–∞:

–î–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è:
```
‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –∞—É–¥–∏–æ –¥–ª—è 'vorstellen': /path/to/media/audio/xxx.mp3
‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è 'vorstellen': /path/to/media/images/xxx.jpg
```

–ï—Å–ª–∏ –≤–∏–¥–∏—Ç–µ:
```
‚ùå –§–∞–π–ª –∞—É–¥–∏–æ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç: /media/audio/xxx.mp3
```

–≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –±—ç–∫–µ–Ω–¥ –Ω–µ –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ –ø—É—Ç–∏ –≤ –∞–±—Å–æ–ª—é—Ç–Ω—ã–µ.

---

## üí° –ò—Ç–æ–≥–æ–≤–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è

**–î–ª—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞:**

1. **–°–µ–π—á–∞—Å (–±—ã—Å—Ç—Ä–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ):** –ü—Ä–µ–æ–±—Ä–∞–∑—É–π—Ç–µ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ –ø—É—Ç–∏ –≤ –ø–æ–ª–Ω—ã–µ URL –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π:
   ```typescript
   const baseURL = 'https://get-anki.fan.ngrok.app';
   const fullImageUrl = imageUrl.startsWith('http') 
     ? imageUrl 
     : `${baseURL}${imageUrl}`;
   ```

2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –ø–æ—Å–ª–µ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è:**
   ```typescript
   const blob = await api.get(`/cards/download/${fileId}/`, {
     responseType: 'blob'
   });
   console.log('–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞:', blob.size / 1024 / 1024, 'MB');
   // –î–æ–ª–∂–Ω–æ –±—ã—Ç—å > 1 MB –¥–ª—è –∫–æ–ª–æ–¥—ã —Å –º–µ–¥–∏–∞
   ```

3. **–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –º–µ–¥–∏–∞—Ñ–∞–π–ª—ã –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –≤ `POST /api/cards/generate/`**, –∞ –Ω–µ –ø—Ä–∏–≤—è–∑—ã–≤–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ `PATCH` –ø–æ—Å–ª–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏.

---

**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 7 –¥–µ–∫–∞–±—Ä—è 2025

