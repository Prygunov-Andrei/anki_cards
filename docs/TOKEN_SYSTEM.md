# Система токенов для генерации карточек

**Дата создания:** 13 ноября 2024

## Расчет стоимости генерации одной карточки

### Компоненты генерации:
1. **Изображение (DALL-E 3)**
   - Модель: `dall-e-3`
   - Размер: 1024x1024
   - Качество: standard
   - **Стоимость: $0.040 за изображение**

2. **Аудио (TTS-1-HD)**
   - Модель: `tts-1-hd`
   - Формат: MP3
   - Стоимость: $0.015 за 1000 символов
   - Средняя длина слова: 5-10 символов
   - **Стоимость: ~$0.00015 - $0.0003 за слово**

### Итого:
**Стоимость одной карточки (изображение + аудио): ~$0.040 - $0.0403**

**Округление для упрощения:** $0.04 за карточку

---

## Система токенов

### Концепция:
- **1 токен = 1 карточка** (не колода!)
- Пользователь тратит 1 токен при генерации каждой карточки
- Баланс токенов отображается в интерфейсе
- Админ может начислять токены через админ-панель

### Структура данных:

#### Модель Token (Backend)
```python
class Token(models.Model):
    user = OneToOneField(User, on_delete=CASCADE)
    balance = IntegerField(default=0)  # Текущий баланс токенов
    total_earned = IntegerField(default=0)  # Всего получено токенов
    total_spent = IntegerField(default=0)  # Всего потрачено токенов
    created_at = DateTimeField(auto_now_add=True)
    updated_at = DateTimeField(auto_now=True)
```

#### Модель TokenTransaction (Backend)
```python
class TokenTransaction(models.Model):
    TRANSACTION_TYPES = [
        ('earned', 'Начислено'),
        ('spent', 'Потрачено'),
        ('refund', 'Возврат'),
    ]
    
    user = ForeignKey(User, on_delete=CASCADE)
    amount = IntegerField()  # Количество токенов
    transaction_type = CharField(choices=TRANSACTION_TYPES)
    description = CharField(max_length=255, blank=True)  # Описание транзакции
    created_by = ForeignKey(User, null=True, blank=True, related_name='transactions_created')  # Кто создал (для админа)
    created_at = DateTimeField(auto_now_add=True)
```

### API Endpoints:

#### 1. Получение баланса токенов
```
GET /api/tokens/balance/
Response: {
    "balance": 100,
    "total_earned": 200,
    "total_spent": 100
}
```

#### 2. Начисление токенов (только для админа)
```
POST /api/tokens/add/
Body: {
    "user_id": 1,
    "amount": 50,
    "description": "Начисление токенов"
}
Response: {
    "success": true,
    "new_balance": 150
}
```

#### 3. Списание токенов (автоматически при генерации)
```
POST /api/tokens/spend/
Body: {
    "amount": 1,
    "description": "Генерация карточки: слово 'casa'"
}
Response: {
    "success": true,
    "new_balance": 99
}
```

#### 4. Возврат токенов (при ошибке генерации)
```
POST /api/tokens/refund/
Body: {
    "amount": 1,
    "description": "Возврат токенов за ошибку генерации: слово 'casa'"
}
Response: {
    "success": true,
    "new_balance": 100
}
```

### Логика списания:

1. При генерации карточки (в `generate_cards_view`):
   - Проверяем баланс токенов пользователя
   - Если баланс >= количество_слов, списываем по 1 токену за каждое слово
   - Если баланс < количество_слов, возвращаем ошибку 402 (Payment Required)
   - Для каждого слова создаем запись в TokenTransaction (тип 'spent')
   - При ошибке генерации возвращаем токены (тип 'refund')

2. При генерации медиа (изображение или аудио):
   - **НЕ списываем токены** (токены списываются только при генерации карточки)
   - Медиа может генерироваться отдельно для предпросмотра

### Админ-панель:

#### Модель Token в админке:
- Отображение баланса пользователя
- Кнопка "Начислить токены"
- История транзакций
- Фильтры по пользователям

### Frontend:

#### Компонент TokenBalance
- Отображение текущего баланса токенов
- Обновление баланса после генерации карточки
- Предупреждение при низком балансе (< 10 токенов)

#### Интеграция в GenerateButton
- Проверка баланса перед генерацией
- Отображение ошибки при недостатке токенов
- Обновление баланса после успешной генерации

---

## Этапы реализации

### Этап 1: Backend - Модели и API
- [ ] Создать модель Token
- [ ] Создать модель TokenTransaction
- [ ] Создать миграции
- [ ] Создать сериализаторы
- [ ] Создать API endpoints
- [ ] Интегрировать списание токенов в `generate_cards_view`

### Этап 2: Админ-панель
- [ ] Зарегистрировать Token в админке
- [ ] Зарегистрировать TokenTransaction в админке
- [ ] Создать интерфейс для начисления токенов
- [ ] Добавить фильтры и поиск

### Этап 3: Frontend
- [ ] Создать компонент TokenBalance
- [ ] Интегрировать в главную страницу
- [ ] Обновить GenerateButton для проверки баланса
- [ ] Добавить обработку ошибок при недостатке токенов

### Этап 4: Тестирование
- [ ] Тесты для моделей Token
- [ ] Тесты для API endpoints
- [ ] Тесты для списания токенов
- [ ] Интеграционные тесты

---

## Примеры использования

### Начисление токенов админом:
1. Админ заходит в админ-панель
2. Выбирает пользователя
3. Нажимает "Начислить токены"
4. Вводит количество (например, 100)
5. Опционально добавляет описание
6. Сохраняет

### Генерация карточки пользователем:
1. Пользователь вводит слова
2. Нажимает "Сгенерировать карточки"
3. Система проверяет баланс токенов
4. Если баланс >= количества слов:
   - Списывает токены (1 токен за слово)
   - Генерирует карточки
   - Обновляет баланс в интерфейсе
5. Если баланс < количества слов:
   - Показывает ошибку "Недостаточно токенов"
   - Предлагает обратиться к админу

---

## Правила списания токенов

### Утвержденные правила:

1. **Списание токенов:**
   - **1 токен = 1 карточка** (слово + перевод + картинка + аудио)
   - Списание происходит только при генерации карточки
   - Если пользователь генерирует медиа отдельно (для предпросмотра), токены НЕ списываются
   - Токены списываются только при финальной генерации карточки в колоду

2. **Генерация колоды:**
   - Если пользователь генерирует колоду из 10 слов, списывается **10 токенов** (по 1 токену за каждое слово)
   - Списание происходит перед генерацией, проверяется баланс

3. **Возврат токенов:**
   - **Да, возврат токенов при ошибке генерации обязателен**
   - Если генерация карточки завершилась с ошибкой, токены возвращаются пользователю
   - Создается транзакция типа "refund" в TokenTransaction

4. **Стоимость:**
   - **Фиксированная цена: 1 токен = 1 карточка**
   - Независимо от реальной стоимости генерации ($0.04)
   - Админ начисляет токены вручную через админ-панель

---

## Логика списания и возврата

### Процесс генерации карточки:

1. **Проверка баланса:**
   ```
   Если balance < количество_слов:
       Вернуть ошибку 402 (Payment Required)
       Сообщение: "Недостаточно токенов. Осталось: {balance}, требуется: {количество_слов}"
   ```

2. **Списание токенов:**
   ```
   Для каждого слова:
       - Списываем 1 токен
       - Создаем транзакцию типа "spent"
       - Описание: "Генерация карточки: {word}"
   ```

3. **Генерация карточки:**
   ```
   Пытаемся сгенерировать карточку:
       - Генерация изображения
       - Генерация аудио
       - Создание карточки в .apkg
   ```

4. **Обработка ошибок:**
   ```
   Если ошибка при генерации:
       - Возвращаем токены пользователю
       - Создаем транзакцию типа "refund"
       - Описание: "Возврат токенов за ошибку генерации: {word}"
   ```

### Пример транзакций:

**Успешная генерация 3 карточек:**
```
1. spent: -1 токен, "Генерация карточки: casa"
2. spent: -1 токен, "Генерация карточки: tempo"
3. spent: -1 токен, "Генерация карточки: vida"
```

**Ошибка при генерации:**
```
1. spent: -1 токен, "Генерация карточки: casa"
2. refund: +1 токен, "Возврат токенов за ошибку генерации: casa"
```

