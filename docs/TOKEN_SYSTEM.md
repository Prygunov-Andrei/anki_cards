# Система токенов

## Обзор

Система токенов используется для контроля использования ресурсов при генерации медиафайлов.

## Баланс токенов

Каждый пользователь имеет баланс токенов, который хранится в модели `Token`.

### Начальный баланс

При регистрации пользователь получает начальный баланс токенов (настраивается в коде).

### Пополнение баланса

Токены могут быть добавлены администратором через API или админ-панель Django.

## Стоимость операций

### Генерация изображений

- **OpenAI DALL-E 3:** 2 токена
- **Google Gemini Flash:** 1 токен (0.5 токена в системе)
- **Google Gemini Nano Banana:** 2 токена (1 токен в системе)

### Генерация аудио

- **OpenAI TTS-1-HD:** 1 токен
- **Google TTS (gTTS):** 0 токенов (бесплатно)

## API

### GET `/api/tokens/balance/`

Получение текущего баланса токенов.

**Ответ:**
```json
{
  "balance": 100,
  "balance_display": 50.0
}
```

### GET `/api/tokens/transactions/`

Получение истории транзакций.

**Ответ:**
```json
{
  "transactions": [
    {
      "id": 1,
      "transaction_type": "spent",
      "amount": 2,
      "description": "Генерация изображения для слова 'Haus'",
      "created_at": "2025-01-01T00:00:00Z"
    }
  ]
}
```

### POST `/api/tokens/add/` (только для администраторов)

Добавление токенов пользователю.

**Тело запроса:**
```json
{
  "user_id": 1,
  "amount": 100,
  "description": "Пополнение баланса"
}
```

## Логика работы

1. При запросе на генерацию медиа проверяется баланс
2. Если баланс достаточен, токены списываются
3. Если баланс недостаточен, возвращается ошибка 402 (Payment Required)
4. Все транзакции логируются в `TokenTransaction`

## Внутренняя реализация

Система использует дробные значения для токенов (0.5, 1.0, 2.0), но хранит их в БД как целые числа:
- 0.5 токена = 1 единица в БД
- 1.0 токен = 2 единицы в БД
- 2.0 токена = 4 единицы в БД

Это позволяет работать с дробными значениями без изменения типа поля в БД.

