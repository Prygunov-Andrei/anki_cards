# Generated by Django 4.2.7 on 2026-01-02 15:53

from django.db import migrations


def fix_all_card_types(apps, schema_editor):
    """
    –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Ç–∏–ø—ã –∫–∞—Ä—Ç–æ—á–µ–∫ –¥–ª—è –≤—Å–µ—Ö —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Å–ª–æ–≤:
    1. –ü—É—Å—Ç—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ (original_word –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å '_empty_') -> 'empty'
    2. –ò–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ (language == source_lang –∫–æ–ª–æ–¥—ã) -> 'inverted'
    3. –û—Å—Ç–∞–ª—å–Ω—ã–µ -> 'normal'
    """
    Word = apps.get_model('words', 'Word')
    Deck = apps.get_model('cards', 'Deck')
    
    # –®–∞–≥ 1: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—É—Å—Ç—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏
    empty_words = Word.objects.filter(original_word__startswith='_empty_')
    empty_count = empty_words.update(card_type='empty')
    print(f"‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ –ø—É—Å—Ç—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫: {empty_count}")
    
    # –®–∞–≥ 2: –ù–∞—Ö–æ–¥–∏–º –∏–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏
    # –ò–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ - —ç—Ç–æ —Å–ª–æ–≤–æ, –∫–æ—Ç–æ—Ä–æ–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –∫–æ–ª–æ–¥–µ,
    # –≥–¥–µ language —Å–ª–æ–≤–∞ == source_lang –∫–æ–ª–æ–¥—ã
    
    # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —Å–ª–æ–≤–∞, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –ø—É—Å—Ç—ã–µ, —Å –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–æ–π —Å–≤—è–∑–µ–π —Å –∫–æ–ª–æ–¥–∞–º–∏
    words_to_check = Word.objects.exclude(original_word__startswith='_empty_').prefetch_related('decks')
    
    # –°–æ–±–∏—Ä–∞–µ–º —Å–ª–æ–≤–∞ –¥–ª—è bulk_update
    words_to_update = []
    inverted_count = 0
    normal_count = 0
    
    for word in words_to_check:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤ –∫–∞–∫–∏—Ö –∫–æ–ª–æ–¥–∞—Ö –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —ç—Ç–æ —Å–ª–æ–≤–æ
        is_inverted = False
        for deck in word.decks.all():
            # –ï—Å–ª–∏ language —Å–ª–æ–≤–∞ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å source_lang –∫–æ–ª–æ–¥—ã, —ç—Ç–æ –∏–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞
            if word.language == deck.source_lang:
                is_inverted = True
                break
        
        if is_inverted:
            word.card_type = 'inverted'
            inverted_count += 1
        else:
            # –ï—Å–ª–∏ —Å–ª–æ–≤–æ –Ω–µ –≤ –∫–æ–ª–æ–¥–∞—Ö –∏–ª–∏ –Ω–µ –∏–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ, —Ç–æ —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞
            word.card_type = 'normal'
            normal_count += 1
        
        words_to_update.append(word)
    
    # –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ —Å–ª–æ–≤–∞ –æ–¥–Ω–∏–º –∑–∞–ø—Ä–æ—Å–æ–º
    if words_to_update:
        Word.objects.bulk_update(words_to_update, ['card_type'], batch_size=1000)
    
    print(f"‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ –∏–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫: {inverted_count}")
    print(f"‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ –æ–±—ã—á–Ω—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫: {normal_count}")
    print(f"üìä –ò—Ç–æ–≥–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ: {empty_count + inverted_count + normal_count} –∫–∞—Ä—Ç–æ—á–µ–∫")


def reverse_fix_all_card_types(apps, schema_editor):
    """
    –û–±—Ä–∞—Ç–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è - –≤—Å–µ –∫–∞—Ä—Ç–æ—á–∫–∏ —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è 'normal'
    """
    Word = apps.get_model('words', 'Word')
    Word.objects.all().update(card_type='normal')


class Migration(migrations.Migration):

    dependencies = [
        ('words', '0004_set_card_types_for_existing_words'),
        ('cards', '0001_initial'),  # –ù—É–∂–Ω–∞ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –º–æ–¥–µ–ª–∏ Deck
    ]

    operations = [
        migrations.RunPython(fix_all_card_types, reverse_fix_all_card_types),
    ]
